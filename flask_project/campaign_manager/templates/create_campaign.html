{% extends 'base.html' %}
{% set active_page = "create" %}

{% block content %}

<div class="row">
  <div class="col-xs-12">
    <h1>Create Project</h1>
    <ul class="nav nav-tabs step-tabs">
      <li class="active"><a href="#general-information" data-toggle="tab">General Information</a></li>
      <li><a href="#area-of-interest" data-toggle="tab">Area of Interest (AOI)</a></li>
      <li><a href="#features-and-attributes" data-toggle="tab">Features &amp; Attributes</a></li>
      <li><a href="#settings" data-toggle="tab">Settings</a></li>
    </ul>
  </div>
</div>

<form id="campaign-form" method="POST" action="{{ url }}" role="form">
  {{ form.hidden_tag() }}
  <div class="row">
    <div class="col-xs-12 col-sm-6">
      <div class="tab-content">
        <div class="tab-pane" id="general-information">
          <fieldset id="fieldset-1" data-fieldset-step="1">
            <div class="form-group">
              <label for="project-name">Project Name <span class="required">*</span></label>
              {{ form.name }}
              <p class="help-block">A project name is required.</p>
            </div>
            <div class="form-group form-date">
              <label for="start-date">Start Date <span class="required">*</span></label>
              {{ form.start_date }}
              <p class="help-block">A start date is required.</p>
            </div>
            <div class="form-group form-date pull-right">
              <label for="end-date">End Date <span class="required">*</span></label>
              {{ form.end_date }}
              <p class="help-block">An end date is required.</p>
            </div>
            <div class="form-group">
              <label for="description">Description</label></label>
              {{ form.description }}
            </div>
            <input id="campaign_status" title="campaign_status" name="campaign_status" style="display: none;" />
            <input id="user_id" title="user_id" name="user_id" style="display: none;" />
          </fieldset>
          <div class="form-footer">
          <a class="btn btn-primary btn-next pull-right">Next</a>
          </div>
        </div>
        <div class="tab-pane" id="area-of-interest">
          <div id="map-notification-holder"></div>
          <fieldset id="fieldset-2" data-fieldset-step="2">
            <div class="form-group">
              <p>Option 1: Set your AOI by using the drawing tools on the map</p>
              <a class="btn btn-default btn-lg btn-expand" data-toggle="modal" data-target="#map-draw-modal">
                Draw on the map
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                  <path fill="#D73F3F" fill-rule="nonzero" d="M15.375 7l-.97.97 3.837 3.843H3v1.374h15.242l-3.837 3.844.97.969 5.5-5.5z" />
                </svg>
              </a>
              {% include 'modals/modal_draw_on_map.html' %}
            </div>
            <div class="form-group">
              <p>Option 2: Upload files to define your AOI (.geojson or .zip containing .shp, .shx, .dbf)</p>
              {% include 'campaign_widget/ui/upload_file.html' %}
            </div>
            <div style="display:none;" class="area-table">
              <div class="area-table-title">
                <label>Label and Assign Campaign Areas (Optional)</label>
              </div>
              <div class="area-table-list"></div>
            </div>
          </fieldset>
          <div class="form-footer">
            <a class="btn btn-previous btn-default">Back</a>
          <a class="btn btn-primary btn-next pull-right">Next</a>
          </div>
        </div>
        <div class="tab-pane" id="features-and-attributes">
          <div id="features-notification-holder"></div>
          <fieldset id="fieldset-3" data-fieldset-step="3">
            <div class="form-group">
              <a id="btn-add" class="btn btn-default btn-lg btn-expand" data-toggle="modal" data-target="#custom-types-tags">
                Add a feature
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                  <path fill="#D73F3F" fill-rule="nonzero" d="M15.375 7l-.97.97 3.837 3.843H3v1.374h15.242l-3.837 3.844.97.969 5.5-5.5z" />
                </svg>
              </a>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <select style="display:none;" id="types" multiple="" name="types"></select>
                <div style="display:none;" class="row">
                  <div class="form-body col-lg-4">
                    <div class="form-group">
                      <label for="types">Types</label><span class="help-block">Add at least one campaign type</span>
                      <div class="types-required-message">This field is required</div>
                    </div>
                  </div>
                </div>
                <div id="typesTagsContainer"></div>
              </div>
            </div>
            <div class="form-footer">
              <a class="btn btn-previous btn-default">Back</a>
              <a class="btn btn-primary btn-next pull-right">Next</a>
            </div>
          </fieldset>
        </div>
        <div class="tab-pane active" id="settings">
          <fieldset id="fieldset-4" data-fieldset-step="4">
            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="project-managers-heading">
                  <h4 class="panel-title">
                    <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#project-managers" aria-expanded="true" aria-controls="project-managers">
                      Project managers
                      <span class="expand-icon pull-right">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                          <g fill="none" fill-rule="evenodd" stroke="#D73F3F" stroke-linecap="square" stroke-width="2">
                            <path d="M19.436 8.37l-7.425 7.425M4.471 8.37l7.425 7.424"/>
                          </g>
                        </svg>
                      </span>
                    </a>
                  </h4>
                </div>
                <div id="project-managers" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="project-managers-heading">
                  <div class="panel-body">
                    <div class="container-fluid">
                      <div class="row">
                        <div class="form-body">
                          <div class="form-group">
                            <input type="text" id="search-osm-user-text" placeholder="Search OpenStreetMap Users" />
                            <div style="display: none;" id="users-not-found">No users found.</div>
                            <div style="display: none;" id="users-found">
                              <select id="list-osm-users" multiple class="form-control"></select>
                              <button type="button" class="btn btn-default" id="add-to-managers">Add manager</button>
                            </div>
                            <div id="managers-list" class="manager-list"></div>
                            <select id="campaign_managers" multiple name="campaign_managers" style="display: none;"></select>
                            <p class="helock"></p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="project-viewers-heading">
                  <h4 class="panel-title">
                    <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#project-viewers" aria-expanded="true" aria-controls="project-viewers">
                      Project viewers
                      <span class="expand-icon pull-right">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                          <g fill="none" fill-rule="evenodd" stroke="#D73F3F" stroke-linecap="square" stroke-width="2">
                            <path d="M19.436 8.37l-7.425 7.425M4.471 8.37l7.425 7.424"/>
                          </g>
                        </svg>
                      </span>
                    </a>
                  </h4>
                </div>
                <div id="project-viewers" class="panel-collapse collapse" role="tabpanel" aria-labelledby="project-viewers-heading">
                  <div class="panel-body">
                    <div class="form-group">
                      <input type="search" class="form-control" id="viewer-search" placeholder="Search OpenStreetMap Users">
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="contributors-heading">
                  <h4 class="panel-title">
                    <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#contributors" aria-expanded="true" aria-controls="contributors">
                      Contributors monitored
                      <span class="expand-icon pull-right">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                          <g fill="none" fill-rule="evenodd" stroke="#D73F3F" stroke-linecap="square" stroke-width="2">
                            <path d="M19.436 8.37l-7.425 7.425M4.471 8.37l7.425 7.424"/>
                          </g>
                        </svg>
                      </span>
                    </a>
                  </h4>
                </div>
                <div id="contributors" class="panel-collapse collapse" role="tabpanel" aria-labelledby="contributors-heading">
                  <div class="panel-body">
                    <div class="form-group">
                      <input type="search" class="form-control" id="contributor-search" placeholder="Search OpenStreetMap Users">
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="openmapkit-heading">
                  <h4 class="panel-title">
                    <a>Integrate with OpenMapKit
                      <label class="toggle-switch" id="link-to-omk-form" for="link_to_omk">
                        {{ form.link_to_omk(checked=link_to_omk) }}
                      </label>
                    </a>
                  </h4>
                </div>
              </div>
              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="custom-basemap-heading">
                  <h4 class="panel-title">
                    <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#custom-basemap" aria-expanded="true" aria-controls="custom-basemap">
                      Custom Basemap
                      <span class="expand-icon pull-right">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                          <g fill="none" fill-rule="evenodd" stroke="#D73F3F" stroke-linecap="square" stroke-width="2">
                            <path d="M19.436 8.37l-7.425 7.425M4.471 8.37l7.425 7.424"/>
                          </g>
                        </svg>
                      </span>
                    </a>
                  </h4>
                </div>
                <div id="custom-basemap" class="panel-collapse collapse" role="tabpanel" aria-labelledby="custom-basemap-heading">
                  <div class="panel-body">
                    <div class="form-group map-input">
                      {{ form.map_type }}
                      {% if form['errors'] %}
                      <p class="error-form">
                        {% if form['errors'].map_type %}
                        {{ form['errors'].map_type[0] }}
                        {% endif %}
                      </p>
                      {% endif %}
                      <p class="help-block">Input <a data-toggle="tooltip" data-title="example: https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png">map url</a> to change map display, leave blank to use default</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </fieldset>
          <div class="form-footer">
            <a class="btn btn-previous btn-default">Back</a>
          <button id="submit" name="submit" type="submit" class="btn btn-primary pull-right submit-button">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xs-12 col-sm-6">
      <div id="campaign-map-display"></div>
    </div>
  </div>
  <div class="row">
    <fieldset id="fieldset-5" data-fieldset-step="5" style="display: none;">
      <div class="row insight-functions">
        <div class="form-body col-lg-12">
          <div class="form-group">
            <div id="insight-function" class="function-wrapper">
              <label class="category-label">Insight Functions</label>
              <div class="function-form"></div>
              <button id="insight-function-add" class="btn btn-outline btn-add-coverage" type=button onclick="addFunction(this)">
                Add Function
              </button>
            </div>
          </div>
        </div>
      </div>
    </fieldset>
  </div>
</form>

{% include 'modals/modal_main.html' %}

{% endblock %}

{% block after_base_js %}
<script type="text/javascript">

  // Validate all inputs inside .tab-pane elements when they change
  document.addEventListener("DOMContentLoaded", ()=>{
    Array.from(document.querySelectorAll('input')).forEach(el=>{
      const pane = el.closest('.tab-pane');
      if (!pane) return;
      const tab = document.querySelector('a[href="#' + pane.id + '"]');
      const formGroup = el.closest('.form-group');
      el.addEventListener('change', e=>{
        const isValid = el.checkValidity();
        if (!isValid) {
          formGroup.classList.add('has-error');
          tab.parent().querySelector('.valid-icon').remove();
        }
      });
      el.addEventListener('focus', removeError);
    });
  })

  $('.step-tabs').find('a').on('hide.bs.tab', function (e) {
    const tabLink = e.target;
    const tabId = tabLink.href.split('#')[1];
    const tabToValidate = document.querySelector('#'+tabId);
    const currentFieldset = tabToValidate.querySelector('fieldset');
    if (!currentFieldset) return;

    const hasValidIcon = !!$(this).parent().find('.valid-icon')[0];
    const step = currentFieldset.dataset.fieldsetStep;
    const isStepValid = checkSteps(step);
    if (isStepValid) {
      const validIcon = $("#_template-valid-icon").html();
      if (!hasValidIcon) $(this).parent().append(validIcon);
      return true;
    } else {
      if (hasValidIcon) $(this).parent().find('.valid-icon').remove();
      e.preventDefault();
      return false;
    }
  });

  $('.btn-next').click(function () {
    $('.step-tabs > .active').next('li').find('a').trigger('click');
  });
  $('.btn-previous').click(function () {
    $('.step-tabs > .active').prev('li').find('a').trigger('click');
  });

  var taskStatusFillColor = {
    'READY': '#FFFFFF',
    'unassigned': '#D3D3D3',
    'MAPPED': '#FFE4B5',
    'INVALIDATED': '#D3D3D3',
    'VALIDATED': '#B0DE5C',
    'complete': '#B0DE5C',
    'incomplete': '#FFE4B5',
    'BADIMAGERY': '#d2a29e'
  };

  var remaining_days = 0;

  if (start_date === 'None' || end_date === 'None') {
    remaining_days = 0;
  } else {
    end_date = moment(end_date.split(' ')[0], 'YYYY-MM-DD', true);
    remaining_days = end_date.diff(moment(), 'days') + 1;
  }

  if (remaining_days > 0) {
    $('#campaign-active').show();
  } else {
    $('#campaign-inactive').show();
  }

  $('#link-to-omk-form').click(function () {
    if ($(this).children(':checked')[0]) {
      $(this).addClass('active');
    } else {
      $(this).removeClass('active');
    }
  });
</script>

<script type="text/javascript" src="/static/js/leaflet.draw-0.4.9/leaflet.draw.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.0/js-yaml.min.js"></script>
<script type="text/javascript" src="/static/js/create/map.js"></script>

<script type="text/javascript" src="/static/js/create/types_tags.js"></script>
<script type="text/javascript" src="/static/js/create/modal.js"></script>
<script type="text/javascript" src="/static/js/create/campaign-json-handler.js"></script>

<script type='text/template' id='_template-function-form'>
  <div class="well well-sm">
    <div class="function-form-row row tooltip-help" id="function-<%=index%>">
      <div class="col-lg-1">
        <button class="btn btn-danger btn-sm btn-block" type=button onclick="removeFunction(this)">
          <i class="fa fa-minus"></i>
        </button>
      </div>
      <div class="col-lg-3">
        <select class="form-control function-selection" data-toggle="tooltip" data-placement="top" data-original-title="Select insight function" onchange="functionOnSelected(this)">
          <option value="">-------------------</option>
            {% for key, value in functions.items() %}
              <option value="{{ key }}">{{ value.name }}</option>
            {% endfor %}
        </select>
      </div>
      <div class="col-lg-2">
        <input class="form-control function-type" data-toggle="tooltip" data-placement="top" data-original-title="Put feature to extract">
      </div>
      <div class="col-lg-2">
        <input class="form-control function-feature" data-toggle="tooltip" data-placement="top" data-original-title="Put feature to extract">
      </div>
      <div class="col-lg-2">
        <input class="form-control function-attributes" data-toggle="tooltip" data-placement="top" data-original-title="Additional attributes for this function">
      </div>
    </div>
  </div>
</script>

<script type='text/template' id='_template-valid-icon'>
  <span class="valid-icon">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#40BB95"/>
      <path d="M18.5 8L10.5 16L5.5 11" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </span>
</script>

<script type='text/template' id='_template-feature-tile'>

<div class="row" id="<%=slug%>-feature-tile">
  <div class="col-xs-12">
    <div class="panel panel-tile">
      <div class="container-fluid">
        <div class="row">
          <div class="col-xs-12">
            <h4 class="panel-name">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.4915 9.44916V18.6363" stroke="#929DB3" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M13.5271 17.4662C18.1481 17.6045 21.661 18.2994 21.661 19.1357C21.661 20.0719 17.26 20.8306 11.8305 20.8306C6.40102 20.8306 2 20.0719 2 19.1357C2 18.3418 5.16746 17.675 9.44271 17.4913" stroke="#929DB3" stroke-linecap="round" stroke-linejoin="round"></path>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M14.8815 6.05933C14.8815 7.93153 13.3635 9.44916 11.4916 9.44916C9.61977 9.44916 8.10181 7.93153 8.10181 6.05933C8.10181 4.18746 9.61977 2.66949 11.4916 2.66949C13.3635 2.66949 14.8815 4.18746 14.8815 6.05933V6.05933Z" stroke="#929DB3" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M11.4915 4.36438C12.4277 4.36438 13.1864 5.12336 13.1864 6.0593" stroke="#929DB3" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
              <%=name%>
            </h4>
            <p><%=osmFeature%></p>
            <a href="#" class="panel-more-button btn-remove-type" onclick="removeTags(this, '<%=slug%>')">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="17" viewBox="0 0 16 19">
                <path fill="#D73F3F" fill-rule="nonzero" d="M15.118 2.57h-3.704V.68a.68.68 0 0 0-.68-.68H5.292a.68.68 0 0 0-.68.68v1.89H.906a.907.907 0 0 0 0 1.815h.908v13.228c0 .626.507 1.133 1.134 1.133h10.128c.626 0 1.133-.507 1.133-1.133V4.385h.908a.907.907 0 0 0 0-1.814zM5.065 16.178a.68.68 0 0 1-1.36 0V6.653a.68.68 0 0 1 1.36 0v9.524zm3.628 0a.68.68 0 0 1-1.36 0V6.653a.68.68 0 0 1 1.36 0v9.524zm1.36-13.606H5.973V1.36h4.082v1.21zm2.268 13.606a.68.68 0 0 1-1.36 0V6.653a.68.68 0 0 1 1.36 0v9.524z" />
              </svg>
            </a>
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12 row-tags-wrapper">
            <div class="row-tags feature-tags"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</script>

<script type='text/template' id='_template-manager'>
  <span class="manager" data-manager="<%=name%>">
    <span class="manager-icon" aria-hidden="true"><%=name[0]%>
      <% if (!isManager) { %>
        <span class="remove-manager" onclick="removeManager(this, '<%=name%>')">Remove</span>
      <% } %>
    </span>
    <span class="manager-name"><%=name%></span>
  </span>
</script>

<script type="text/javascript">
  typesOptions = '{{ form.types_options }}';
  var initialLoad = true;
  var selectedFunctions = [];
  var types = {{ types| safe }};
  var selected_types_data = {};
  {% if form.types.data %}
  selected_types_data = {{ form.types.data | safe }};
  addMultipleTypes(selected_types_data);
  {% endif %}
  initialLoad = false;

  var remote_projects_list = [];
  {% if form.remote_projects.data %}
  remote_projects_list = {{ form.remote_projects.data | safe }};
  {% endif %}

  //------------------ CAMPAIGN MANAGERS ------------------//
  var managers_list = [];
  {% if form.campaign_managers.data %}
  managers_list = {{ form.campaign_managers.data | safe }};
  {% endif %}
  {% if campaign_creator %}
  var campaign_creator = '{{ campaign_creator }}';
  {% endif %}

  function updateManagerList() {
    $('#managers-list').html('');
    if (managers_list.length > 0) {
      $.each(managers_list, function (index, value) {
        const managerTemplate = _.template($("#_template-manager").html());
        const managerEl = managerTemplate({
          name: value,
          isManager: typeof campaign_creator !== 'undefined' && value == campaign_creator
        });
        $('#managers-list').append(managerEl);
      })
    }
  }
  $('#form-panel').hide();
  $(function () {
    updateManagerList();
  });

  function removeManager(e, manager) {
    var index = managers_list.indexOf(manager);
    if (index > -1) {
      managers_list.splice(index, 1);
    }
    $('[data-manager=' + manager + ']').remove();
  }

  $("#add-to-managers").click(function () {
    var listOsmUsers = [];
    $('#list-osm-users :selected').each(function (i, selected) {
      listOsmUsers[i] = $(selected).text();
    });

    $('.error-managers').hide();

    for (var i = 0; i < listOsmUsers.length; i++) {
      if ($.inArray(listOsmUsers[i], managers_list) === -1) {
        managers_list.push(listOsmUsers[i]);
        const managerTemplate = _.template($("#_template-manager").html());
        const managerEl = managerTemplate({
          name: listOsmUsers[i],
          isManager: false
        });
        $('#managers-list').append(managerEl)
      }
    }

  });

  $("#search-osm-user-button").click(function () {
    searchOsmUser();
  });

  $('#search-osm-user-text').keypress(function (e) {
    if (e.which === 13) {
      searchOsmUser();
    }
  });

  function searchOsmUser() {
    var textInput = $('#search-osm-user-text').val();
    var url = 'http://whosthat.osmz.ru/whosthat.php?action=names&q=' + textInput;
    var $searchOsmButton = $('#search-osm-user-button');
    $searchOsmButton.attr('disabled', 'disabled');
    $searchOsmButton.LoadingOverlay("show", { image: "/static/resources/loading-spinner.gif" });
    $('#users-not-found').hide();
    $('#users-found').hide();
    $.ajax({
      url: url,
      success: function (data) {
        const names = _.map(data, (user)=>user.names[0]);
        $searchOsmButton.removeAttr('disabled');
        $searchOsmButton.LoadingOverlay("hide");
        $('#list-osm-users').html('');

        if (names.length > 0) {
          $('#users-found').show("slow");
        } else {
          $('#users-not-found').show("slow");
        }

        $.each(names, function (index, value) {
          $('#list-osm-users').append($('<option/>', {
            value: value,
            text: value
          }));
        });
      }
    });
  }

  //------------------ EVENT ------------------//

  function reloadUser() {
    var that = this;
    auth.xhr({
      method: 'GET',
      path: '/api/0.6/user/details'
    }, function (err, res) {

      var u = res.getElementsByTagName('user')[0];
      var changesets = res.getElementsByTagName('changesets')[0];

      var o = {
        display_name: u.getAttribute('display_name'),
        id: u.getAttribute('id'),
        count: changesets.getAttribute('count')
      };
      updated(o);

    }, this);
  }

  function updated(response) {
    {% if action == 'edit' %}
    var is_manager = $.inArray(response.display_name, managers_list);
    if (is_manager == -1) {
      location.href = '/404';
    } else {
      $('#form-panel').show();
      $('#campaign-panel').show();
      $('#submit').show();
    }
    {% else %}
    $('#form-panel').show();
    $('#campaign-panel').show();
    $('#submit').show();
    {% endif %}
    {% if action == 'create' %}
    managers_list.push(response.display_name);
    const managerTemplate = _.template($("#_template-manager").html());
    const managerEl = managerTemplate({
      name: response.display_name,
      isManager: true
    });
    $('#managers-list').append(managerEl);
    $("#user_id").val(response.id);
    {% endif %}
  }

  if (!window.isAuthenticated) {
    window.location.replace("/");
  } else {
    {% if action == 'create' %}
    $('#form-panel').show();
    $('#campaign-panel').show();
    $('#submit').show();
    {% endif %}
  }

  function updateMap(mapInstance) {
    mapInstance.invalidateSize();
    if (drawnItems.getLayers().length > 0) {
      mapInstance.fitBounds(drawnItems.getBounds());
      getAreaSize();
      stringfyGeometry();
    } else {
      mapInstance.setView([0, 0], 2);
    }
  }

  updateMap(campaignDisplayMap);

  if (!isEmpty(errors)) {
    showNotifications('Failed to create a campaign!', 'danger');
  }

  function checkSteps(step) {
    switch(step) {
      case '1':
        return checkStep1();
        break;
      case '2':
        return checkStep2();
        break;
      case '3':
        return checkStep3();
        break;
      case '5':
        return checkStep5();
        break;
      default:
        return true;
    }
  }

  function removeError(e) {
    e.target.closest('.form-group').classList.remove('has-error');
  }

  function checkStep1() {
    const hasInvalidFields = Array.from(document.querySelectorAll('#fieldset-1 [required]')).map(el=>{
      const isValid = el.checkValidity();
      if (!isValid) {
        el.closest('.form-group').classList.add('has-error');
      }
      return isValid;
    }).some(val=>!val);

    const startValue = moment(document.querySelector('#start_date').value);
    const endValue = moment(document.querySelector('#end_date').value);
    const isStartBeforeEnd = startValue.isBefore(endValue);

    if (managers_list.length === 0) {
      reloadUser();
    }
    return !hasInvalidFields && isStartBeforeEnd;
  }

  function checkStep2() {
    var valid = true;
    var mapErrorNotification = $('.map-wrapper').data('error');
    clearNotification();
    if (!!mapErrorNotification) {
      showNotifications(mapErrorNotification, 'danger', '#map-notification-holder');
      valid = false;
    }
    if (drawnItems.getLayers().length === 0) {
      showNotifications('Map is empty, please draw a layer or upload boundary.', 'danger', '#map-notification-holder');
      valid = false;
    }
    return valid;
  }

  function checkStep3() {
    let valid = true;
    var types_value = getTypesSelectionValue();
    $("#types").val(JSON.stringify(types_value));
    rerenderFunction();
    if (jQuery.isEmptyObject(types_value)) {
      valid = false;
      showNotifications('You must add at least one feature to the project.', 'danger', '#features-notification-holder');
    }
    return valid;
  }

  function checkStep5() {
    var valid = true;

    clearNotification();

    var campaignJson = $('#advanced-mode-textarea').val();

    if (campaignJson) {
      campaignJson = JSON.parse(campaignJson);
      var rows = $('#insight-function').find('.function-form').find('.function-form-row');
      $.each(rows, function (index, row) {
        if (!$(row).find('.function-selection').val()) {
          var function_name = campaignJson['selected_functions']['function-' + (index + 1)]['function'];
          showNotifications(function_name + ' is not an insight function.', 'danger');
          valid = false;
        }
      });
    }

    return valid;
  }

  function nextStep(elm) {
    var currentActiveStep = $('.cc-nav-steps').find('.cc-nav.active');
    var progressLine = $(elm).parents('.cc').find('.cc-progress-line');
    var parentFieldset = $(elm).parents('fieldset');
    var currentFieldsetNumber = parentFieldset.data('fieldset-step');

    var currentStep = currentActiveStep.data('step');
    var totalSteps = progressLine.data('number-of-steps');

    if (currentStep === totalSteps) return;

    var isNextStep = checkSteps(currentStep);
    var nameDateValid = checkFormHeader();

    if (isNextStep && nameDateValid) {
      $(parentFieldset).children().find('button').attr('disabled', 'disabled');
    }
  }

  function prevStep(elm) {
    var currentActiveStep = $('.cc-nav-steps').find('.cc-nav.active');
    var parentFieldset = $(elm).parents('fieldset');
    var currentFieldsetNumber = parentFieldset.data('fieldset-step');

    var currentStep = currentActiveStep.data('step');

    if (currentStep === 1) return;

    $(parentFieldset).children().find('button').attr('disabled', 'disabled');
  }

  function checkFormHeader() {
    var valid = true;
    var required_forms = $('.form-header').find('.required-form');

    $.each(required_forms, function (index, value) {
      var input_form = $(value).find("[type=text]");

      if (input_form.length > 0) {
        input_form.removeClass('error');

        input_form.click(function () {
          $(this).removeClass('error');
          $(this).attr('placeholder', '');
        });

        if (input_form.val() === '') {
          input_form.addClass('error');
          input_form.attr('placeholder', 'This field is required');
          valid = false;
        }
      }
    });

    return valid;
  }

  $(function () {

    $('input#name').focus();
    $(document).tooltip({
      selector: "[data-toggle=tooltip]",
      container: "body"
    });

    $(".submit-button").click(function () {
      if (!$('.submit-button').hasClass('disabled')) {
        $("#campaign-form").submit();
      }
    });

    $('#campaign-form input').addClass('form-control');
    $('#campaign-form textarea').addClass('form-control');
    $('#campaign-form select').addClass('form-control');
    $('#link_to_omk').removeClass('form-control');

    if ($("#selected_functions").val()) {
      var selected_functions = $.parseJSON($("#selected_functions").val());
      selectedFunctions = selected_functions;
      $.each(selected_functions, function (key, functions) {
        addFunction($('#insight-function-add'), functions);
      });
    }

  });

  function get_selected_functions() {
    var functions = {};
    var rows = $('#insight-function').find('.function-form').find('.function-form-row');
    $.each(rows, function (index, row) {
      if ($(row).find('.function-selection').val()) {
        functions[$(row).attr('id')] = {
          'function': $(row).find('.function-selection').val(),
          'feature': $(row).find('.function-feature').val(),
          'attributes': JSON.parse($(row).find('.function-attributes').val()),
          'type': $(row).find('.function-type').val()
        }
      }
    });
    return functions;
  }
  function checkingAllStep() {
    var valid = true;
    $("fieldset").each(function (index, el) {
      var step = el.id.split('-')[1];
      var validStep = checkSteps(step);
      if (!validStep) {
        valid = validStep;
      }

    });
    var validHeader = checkFormHeader();
    if (!validHeader) {
      valid = validHeader;
    }
    return valid;
  }
  function preprocessSubmitForm() {
    $("#uploader").val($("#profile-name").html());

    $('#campaign_managers').html('');
    $.each(managers_list, function (index, value) {
      $('#campaign_managers').append('<option selected="selected" value="' + value + '">' + value + '</option>')
    });
    
    $('#campaign_status').val('Start');

    // Processing selected function
    var selected_functions = {};
    selected_functions = $.extend({}, selected_functions, get_selected_functions());
    $("#selected_functions").val(JSON.stringify(selected_functions));

  }
  $("#campaign-form").submit(function (event) {
    if (!auth.authenticated()) {
      event.preventDefault();
      return alert('You are not logged in. Please log in before submitting this form.');
    }
    var allValid = checkingAllStep();
    if (!allValid) {
      event.preventDefault();
      return false;
    }
    preprocessSubmitForm();
  });

  function getFormElement(event, className) {
    return $(event).closest("div").find(className);
  }

  var function_index = 1;
  function addFunction(event, data) {
    $(event).blur();
    var template = _.template($("#_template-function-form").html());
    var html = template({ index: function_index });
    getFormElement(event, '.function-form').append(html);

    var row = $('#function-' + function_index);

    if (data) {
      getFormElement(row, '.function-selection').val(data['function']);
      functionOnSelected(getFormElement(row, '.function-selection'));
      getFormElement(row, '.function-type').val(data['type']);
      getFormElement(row, '.function-feature').val(data['feature']);
      getFormElement(row, '.function-attributes').val(JSON.stringify(data['attributes']));
    }
    function_index += 1;
  }

  function functionOnSelected(event) {
    var $event = $(event).parent().parent();
    getFormElement($event, '.function-feature').html('');
    getFormElement($event, '.function-attributes').val('');
    getFormElement($event, '.function-feature').hide();
    getFormElement($event, '.function-attributes').hide();
    getFormElement($event, '.function-type').hide();

    var insightFunctionName = $(event).val();

    if (insightFunctionName !== '') {
      var need_feature = 'false';
      var need_required_attributes = 'false';

      if (typeof functions[insightFunctionName] !== 'undefined') {
        need_feature = functions[insightFunctionName]['need_feature'];
        need_required_attributes = functions[insightFunctionName]['need_required_attributes'];
      }

      if (need_feature === 'true') {
        getFormElement($event, '.function-type').show();
        getFormElement($event, '.function-feature').show();
      }
      if (need_required_attributes === 'true') {
        getFormElement($event, '.function-attributes').show();
      }
    }
  }

  function removeFunction(event) {
    $(event).parent().parent().parent().remove();
  }

  $("#start_date").attr('data-language', 'en');
  $("#end_date").attr('data-language', 'en');

  $("#start_date").datepicker({
    dateFormat: 'yyyy-mm-dd',
    autoClose: true,
    onSelect: function (date) {
      $("#end_date").val(date);
      $("#end_date").datepicker({ minDate: new Date(date) })
      $('#start-date-value').html(date.toString())
    }
  });

  $("#end_date").datepicker({
    dateFormat: 'yyyy-mm-dd',
    autoClose: true,
    onSelect: function (date) {
      $("#start_date").val(date);
      $("#start_date").datepicker({ maxDate: new Date(date) })
      $('#end-date-value').html(date.toString())
    }
  });

  $("#start-date-icon").click(function () {
    $('#start_date').datepicker().data('datepicker').show()
  });

  $("#end-date-icon").click(function () {
    $('#end_date').datepicker().data('datepicker').show()
  });

  $(function () {
    var end = Date.parse($("#end_date").val());
    var start = Date.parse($("#start_date").val());
    if (start > end) {
      $("#end_date").val($("#start_date").val());
    }

    {% if form.start_date.data and form.end_date.data %}
    var start_date = $("#start_date").val();
    var end_date = $("#end_date").val();
    $('#start-date-value').html(start_date.toString());
    $('#end-date-value').html(end_date.toString());

    $("#start_date").datepicker({
      maxDate: new Date($("#end_date").val().toString())
    });
    $('#start_date').datepicker().data('datepicker').selectDate(new Date(start_date.toString()));

    $("#end_date").datepicker({
      minDate: new Date($("#start_date").val().toString())
    });
    $('#end_date').datepicker().data('datepicker').selectDate(new Date(end_date.toString()));
    {% endif %}

  })

</script>

{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/js/leaflet.draw-0.4.9/leaflet.draw.css" type="text/css">
<script type="text/javascript">
  var isInCreateMode = ("{{ form.name.data }}" === "None") ? true : false;
  var errors = {{ form['errors'] | safe}};
  var functions = {{ functions| safe }};
  var map_provider = "{{ map_provider }}";
  var oneTimeFunctions = [];
  $.each(functions, function (key, value) {
    if (!value['need_feature']) {
      oneTimeFunctions.push(key)
    }
  });

  var remote_projects_list = [];
  {% if form.remote_projects.data %}
  remote_projects_list = {{ form.remote_projects.data | safe }};
  {% endif %}

  var maxAreaSize = {{ maximum_area_size }};

  var start_date = '{{ form.start_date.data }}';
  var end_date = '{{ form.end_date.data }}';
</script>
{% endblock %}