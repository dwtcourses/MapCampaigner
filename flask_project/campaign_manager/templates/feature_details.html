{% extends 'base.html' %}
{% set active_page = "features" %}

{% block extra_title %}
- {{ name }}
{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="/static/js/leaflet.draw-0.4.9/leaflet.draw.js"></script>
<link href="/static/css/campaign-detail.css" rel="stylesheet">
{% endblock %}

{% block subhead %}
{% include 'components/project_header.html' %}
{% endblock %}

{% block content %}
<div class="row" style="margin-bottom: 32px;">
  <div class="col-xs-12">
    <h2 class="pull-left">{{ feature_details['type'] }}</h2>
  </div>
</div>
<div class="row">
  <div class="col-xs-12 col-md-4">
    <div class="row">
        <div class="col-xs-12">
            <div class="panel panel-tile">
              <div class="container-fluid">
                <div class="row">
                  <div class="col-xs-12">
                    <h4 class="panel-name">Attributes checked</h4>
                    <br />
                    {% for tag in feature_details['tags'] %}
                    <span class="label label-default key-tags" title="{{ tag }}">{{ tag }}</span>
                    {% endfor %}
                    <h4 class="panel-name">Total changesets made</h4>
                    <strong class="panel-total text-left">{{ feature_details['feature_count'] }}</strong>
                    <h4 class="panel-name">Attribute completeness</h4>
                    {% set completeness = (feature_details['complete']/feature_details['feature_count']*100)|round|int %}
                    <strong class="panel-total text-left">{{ completeness }}%</strong>
                    <p class="pull-right">{{ feature_details['complete'] }}/{{ feature_details['feature_count'] }}</p>
                    <div class="progress">
                      <div class="progress-bar" id="campaign-progress" role="progressbar" aria-valuenow="{{ completeness }}" aria-valuemin="0" aria-valuemax="100" style="width:{{ completeness }}%">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
    </div>
  </div>
  <div class="col-xs-12 col-md-8">
    {% include 'campaign_detail/map.html' %}
  </div>
</div>
{% endblock %}

{% block after_base_js %}
<script type="text/javascript">

  const activeType = "{{ feature_name | safe }}";
  const s3CampaignUrl = "{{ s3_campaign_url | safe }}";

  function getTypeUrl(activeType, s3CampaignUrl) {
    return s3CampaignUrl + '/render/' + activeType + '/';
  }

  function addMapElements(activeType) {
    var url_vt =  "{{ s3_campaign_url | safe }}/render/" + activeType + "/tiles/{z}/{x}/{y}.pbf";
    map.on('load', function () {
      map.addSource('tiles', {
        "type": "vector",
        "minzoom": 10,
        "maxzoom": 17,
        "tiles": [url_vt]
      });
      map.addLayer({
        "id": "campaign-polygons",
        "type": "fill",
        "source": "tiles",
        "source-layer": "campaign",
        "filter": ["in", "$type", "Polygon"],
        "paint": {
          "fill-color": ['get', 'completeness_color'],
          "fill-opacity": 1
        }
      });
      map.addLayer({
        "id": "campaign-lines",
        "type": "line",
        "source": "tiles",
        "source-layer": "campaign",
        "filter": ["in", "$type", "LineString"],
        "paint": {
          "line-color": ['get', 'completeness_color'],
          "line-opacity": 0.7
        }
      });
      map.addLayer({
        "id": "campaign-points",
        "type": "circle",
        "source": "tiles",
        "source-layer": "campaign",
        "filter": ["in", "$type", "Point"],
        "paint": {
          "circle-color": ['get', 'completeness_color'],
        }
      });
    })
  }

  function setMapHeight() {
    var height = $('.map-side-panel').height();
    $('.map-wrapper').height(height + 3);
    $('#campaign-map-detail').height(height + 3);
  }

  function loadType(activeType, s3CampaignUrl) {
    activeType = activeType.replace(/ /g, '_')
    var typeUrl = getTypeUrl(activeType, s3CampaignUrl);
    $.get({
      url: typeUrl + 'content.html',
      cache: false
    }).then(function (data) {
      $('#campaign-feature-details').show();
      $('#campaign-computing-status').hide();
      data = data.replace("type: 'bar'", "type: 'horizontalBar'")
      let str_token = "options: {"
      let scale_opt = '\n          maintainAspectRatio: false, scales: { yAxes: [{ticks: {fontSize: 13}}]},\n'
      let index_split = data.match(str_token).index + str_token.length
      data = data.substr(0, index_split) + scale_opt + data.substr(index_split + 1)
      data = data.replace(", 'backgroundColor': ['#4286f4']", '')
      $('.content-wrapper').html(data);
    });
    $.get({
      url: typeUrl + 'errors.html',
      cache: false
    }).then(function (data) {
      $('.errors-wrapper').html(data)
    });
    window.setTimeout(function () {
      setMapHeight();
    }, 2000);
    let source = map.getSource('tiles');
    if (source) {
      map.removeLayer("campaign-polygons");
      map.removeLayer("campaign-lines");
      map.removeLayer("campaign-points");
      map.removeSource('tiles');
    }
    addMapElements(activeType);
  }
  loadType(activeType, s3CampaignUrl)
</script>
{% endblock %}